<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>virtualmachine.hpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#pragma once

/*
* Single-threaded RandomX VirtualMachine with JIT-compiler:
* https://github.com/tevador/RandomX/blob/master/doc/specs.md#2-algorithm-description
* https://github.com/tevador/RandomX/blob/master/doc/specs.md#4-virtual-machine
* https://github.com/tevador/RandomX/blob/master/doc/specs.md#5-instruction-set
* 
* This is used to generate and execute RandomX programs and return single RandomX hash.
*/

#include &lt;span&gt;

#include "dataset.hpp"
#include "heaparray.hpp"

namespace modernRX {
    // RandomX program JIT-compiled function.
    // ctx - pointer to ProgramContext.
    // scratchpad - pointer to Scratchpad.
    // dataset - pointer to Dataset.
    using JITRxProgram = void(*)(const uintptr_t ctx, const uintptr_t scratchpad, const uintptr_t dataset);

    // Forward declarations.
    struct ProgramContext;
    struct RxInstruction;
    struct RxProgram;

    // Defines RandomX VM bytecode executor.
    class VirtualMachine {
    public:
        // Creates VirtualMachine instance.
        // Seed is overtaken by VirtualMachine and shouldnt be used after creation.
        [[nodiscard]] explicit VirtualMachine(std::span&lt;std::byte, 64&gt; seed, const_span&lt;DatasetItem&gt; dataset);
        
        // Executes chained RandomX programs based on seed provided at creation.
        // Returns result as a 32-bytes hash of final RegisterFile.
        [[nodiscard]] std::array&lt;std::byte, 32&gt; execute();
    private:
        // Generates program based on current seed value.
        [[nodiscard]] std::pair&lt;ProgramContext, RxProgram&gt; generateProgram();

        // JIT-compile RandomX program.
        void compileProgram(const ProgramContext&amp; ctx, const RxProgram&amp; program);

        std::array&lt;std::byte, 64&gt; seed;
        const_span&lt;DatasetItem&gt; dataset;
        HeapArray&lt;std::byte, 4096&gt; scratchpad;
<span style = "background-color:#dfd">        jit_function_ptr&lt;JITRxProgram&gt; jit{ nullptr };</span>
    };
}</pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>