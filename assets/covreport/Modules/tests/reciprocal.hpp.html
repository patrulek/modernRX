<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>reciprocal.hpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
    <body onload="prettyPrint()">
        <h4></h4>
        <pre class="prettyprint lang-cpp linenums">
#pragma once

/*
* Defines helper function that returns reciprocal values.
* Used by RandomX algorithm.
*/

#include &lt;bit&gt;

#include "assertume.hpp"

// Calculates reciprocal = 2**x / divisor for highest integer x such that reciprocal &lt; 2**64.
// divisor must not be 0 or a power of 2
// 
// Equivalent x86 assembly (divisor in rcx):
// 
// mov edx, 1
// mov r8, rcx
// xor eax, eax
// bsr rcx, rcx
// shl rdx, cl
// div r8
// ret
<span style = "background-color:#dfd">[[nodiscard]] constexpr uint64_t reciprocal(const uint32_t divisor) noexcept {</span>
    // Divisor will never be 0 or a power of 2.
<span style = "background-color:#dfd">    ASSERTUME(divisor != 0 &amp;&amp; !std::has_single_bit(divisor));</span>

<span style = "background-color:#dfd">    constexpr uint64_t p2exp63{ 1ULL &lt;&lt; 63 };
    const uint64_t quotient{ p2exp63 / divisor };
    const uint64_t remainder{ p2exp63 % divisor };</span>

<span style = "background-color:#dfd">    uint32_t shift{ 32 };
    for (uint32_t k = 1U &lt;&lt; 31; (k &amp; divisor) == 0; k &gt;&gt;= 1) {
        --shift;
    }</span>

<span style = "background-color:#dfd">    return (quotient &lt;&lt; shift) + ((remainder &lt;&lt; shift) / divisor);
}</span></pre>
        <hr />
        <table width="100%">
            <thead>
                <tr>
                    <th align="center">
                        <small>Generated by</small>
                        <a href="https://github.com/OpenCppCoverage/OpenCppCoverage/releases">
                            <strong>OpenCppCoverage (Version: 0.9.9.0)</strong>
                        </a>
                    </th>
                </tr>
            </thead>
        </table>
    </body>
</html>